import numpy as np
import sys, os, re, random
import h5py
import string
import tqdm
from imageio import imread
from core.project.project import Project
from utils.img import get_safe_selection
from utils.video_manager import get_auto_video_manager
import time
from utils.img import apply_ellipse_mask
from core.graph.region_chunk import RegionChunk

ELLIPSE_DILATION = 10
MASK_SIGMA = 10

OUT_DIR = '/Volumes/Seagate Expansion Drive/CNN_HH1_POST'
WD = '/Volumes/Seagate Expansion Drive/HH1_POST'
BATCH_SIZE = 30000


def save_batch(batch_i, imgs, ids):
    global OUT_DIR
    print "Saving batch: ", batch_i

    imgs = np.array(imgs)
    imgs = imgs.astype('float32')
    imgs /= 255

    batch_s = str(batch_i)
    while len(batch_s) < 3:
        batch_s = "0" + batch_s

    with h5py.File(OUT_DIR + '/test/batch_' + batch_s + '_imgs.h5', 'w') as hf:
        hf.create_dataset("data", data=imgs)

    with h5py.File(OUT_DIR + '/test/batch_' + batch_s + '_ids.h5', 'w') as hf:
        hf.create_dataset("data", data=ids)


if __name__ == '__main__':
    if len(sys.argv) > 2:
        WD = sys.argv[1]
        OUT_DIR = sys.argv[2]
        if len(sys.argv) > 3:
            BATCH_SIZE = string.atoi(sys.argv[3])

    p = Project()
    p.load(WD)

    MARGIN = 1.25
    major_axis = 36

    offset = major_axis * MARGIN

    id = 0

    try:
        os.mkdir(OUT_DIR)
    except:
        pass

    vm = get_auto_video_manager(p)

    print "Exporting test examples: "

    try:
        os.mkdir(OUT_DIR + '/test')
    except:
        pass

    p.img_manager.max_size_mb = 500

    batch_i = 0
    imgs = []
    ids = []

    # TODO: skip multi regions

    print p.chm

    rids = [697582,
            697591,
            607397,
            611628,
            611640,
            611816,
            612144,
            612349,
            702165,
            439098,
            439107,
            439111,
            439346,
            439349,
            620134,
            620137,
            620142,
            620145,
            620146,
            620150,
            620152,
            620156,
            620158,
            620162,
            620166,
            620167,
            620171,
            620173,
            620176,
            620180,
            620183,
            620190,
            620192,
            620196,
            620198,
            620200,
            620204,
            620206,
            620705,
            609900,
            524072,
            704802,
            704803,
            447914,
            447920,
            704884,
            706082,
            706086,
            706090,
            706093,
            679443,
            712383,
            712387,
            712391,
            712396,
            712398,
            712407,
            491996,
            492000,
            492003,
            506333,
            723119,
            758418,
            758421,
            758424,
            758428,
            723375,
            723391,
            723395,
            723399,
            723406,
            723482,
            758908,
            759510,
            441501,
            485653,
            499630,
            704131,
            704136,
            704142,
            704147,
            704152,
            704157,
            704163,
            704171,
            704179,
            704185,
            704190,
            704195,
            704198,
            704208,
            704212,
            704217,
            704224,
            704228,
            704234,
            704239,
            704244,
            704249,
            704252,
            704259,
            704266,
            704269,
            704274,
            704278,
            704283,
            704288,
            704293,
            704299,
            704594,
            704597,
            704599,
            704606,
            580735,
            580769,
            707293,
            707295,
            498331,
            696664,
            696669,
            696676,
            696680,
            696684,
            696688,
            696692,
            452936,
            455033,
            465845,
            465850,
            466020,
            466026,
            698806,
            698833,
            698836,
            698840,
            698842,
            698845,
            740818,
            536792,
            537162,
            537168,
            538253,
            503076,
            503560,
            518064,
            749795,
            529819,
            703623,
            703627,
            758056,
            468322,
            468341,
            466486,
            664720,
            518740,
            518742,
            645638,
            645645,
            645648,
            645651,
            645654,
            645658,
            645662,
            645666,
            645672,
            645676,
            645678,
            645683,
            645688,
            645691,
            645698,
            645701,
            645704,
            645707,
            645714,
            645717,
            645724,
            645729,
            645734,
            645739,
            645743,
            645747,
            645751,
            645756,
            645761,
            645765,
            645769,
            645772,
            645776,
            645779,
            645783,
            645787,
            645791,
            645797,
            645872,
            645873,
            645874,
            645875,
            645876,
            645877,
            645878,
            645879,
            645880,
            645881,
            645882,
            645883,
            645884,
            645885,
            645886,
            645887,
            645888,
            645889,
            645890,
            645891,
            645892,
            645893,
            645845,
            645849,
            722392,
            722397,
            722403,
            722605,
            722606,
            722607,
            722608,
            722609,
            722610,
            722611,
            722612,
            722613,
            722614,
            722615,
            722616,
            722617,
            722618,
            722619,
            722620,
            722621,
            722622,
            722623,
            722624,
            722625,
            722626,
            722627,
            722628,
            722629,
            722630,
            722631,
            722542,
            722549,
            722554,
            722562,
            722568,
            722572,
            722579,
            722585,
            722589,
            722595,
            722602,
            722635,
            722642,
            722648,
            722653,
            722659,
            722666,
            722672,
            722678,
            722683,
            722690,
            722696,
            722698,
            722703,
            722708,
            722711,
            722715,
            722720,
            722726,
            722732,
            722736,
            722744,
            722748,
            722755,
            722763,
            722768,
            722774,
            534955,
            534961,
            512365,
            512369,
            408043,
            679204,
            481553,
            510563,
            471320,
            472978,
            489382,
            489515,
            552375,
            575703,
            723122,
            723130,
            723134,
            723137,
            723144,
            723149,
            723154,
            723157,
            723164,
            723169,
            723223,
            723229,
            723235,
            723239,
            723245,
            723249,
            723256,
            723261,
            723264,
            723268,
            723273,
            723279,
            723284,
            723288,
            723293,
            723300,
            723304,
            463334,
            463339,
            463340,
            665127,
            506337,
            506732,
            544676,
            544678,
            544680,
            544681,
            544683,
            764730,
            764733,
            715904,
            715990,
            715992,
            715994,
            715996,
            715998,
            716340,
            716342,
            716344,
            716346,
            716348,
            716350,
            716352,
            716354,
            716356,
            716357,
            716359,
            716361,
            716364,
            716366,
            716367,
            716370,
            716372,
            716373,
            716375,
            716377,
            716379,
            716381,
            716383,
            716385,
            716388,
            716389,
            716391,
            716393,
            716395,
            716397,
            716400,
            716599,
            716603,
            716605,
            716607,
            716610,
            716612,
            716614,
            716616,
            716618,
            716620,
            716622,
            716624,
            716626,
            716628,
            716630,
            716632,
            716634,
            716636,
            716638,
            716640,
            716642,
            640393,
            626834,
            626888,
            725169,
            725175,
            697918,
            697922,
            697927,
            697931,
            697935,
            697940,
            697944,
            697952,
            697956,
            697961,
            697965,
            697969,
            697974,
            697975,
            697981,
            697985,
            697990,
            697994,
            697997,
            697999,
            698003,
            698009,
            742158,
            684224,
            442279,
            442281,
            442284,
            442287,
            442290,
            442294,
            442296,
            442300,
            442303,
            511622,
            688062,
            688091,
            688097,
            688103,
            688110,
            689807,
            689955,
            689961,
            689965,
            688026,
            688235,
            386041,
            543952,
            596088,
            596093,
            596097,
            596100,
            596105,
            596109,
            596112,
            556429,
            515766,
            515777,
            592670,
            592674,
            551276,
            522017,
            522523,
            459221,
            459227,
            459233,
            459237,
            459241,
            459248,
            459253,
            459256,
            459262,
            528783,
            476627,
            649187,
            523081,
            601097,
            601102,
            601107,
            601112,
            601117,
            601122,
            601129,
            601133,
            601139,
            550730,
            550733,
            550776,
            550781,
            550783,
            496341,
            496366,
            585530,
            585633,
            585639,
            572380,
            474948,
            474950,
            474952,
            474955,
            474958,
            474961,
            474967,
            474972,
            474978,
            474983,
            648351,
            648356,
            766227,
            570694,
            632443,
            632478,
            632481,
            632488,
            758681,
            758694,
            758697,
            730868,
            730873,
            730878,
            730883,
            730888,
            730892,
            730952,
            730955,
            731011,
            734552,
            734591,
            734692,
            735043,
            668639,
            636363,
            661366,
            661370,
            661376,
            661378,
            661381,
            661388,
            661389,
            661394,
            661399,
            661403,
            661407,
            661409,
            661415,
            661420,
            661423,
            661426,
            661430,
            661433,
            661437,
            661441,
            661446,
            661450,
            661455,
            661457,
            661462,
            661465,
            661472,
            601408,
            601414,
            601418,
            601424,
            601430,
            601434,
            601440,
            601445,
            601447,
            601453,
            601458,
            601463,
            601468,
            601473,
            601481,
            601483,
            601490,
            601492,
            601498,
            601503,
            601508,
            601513,
            601520,
            601524,
            601529,
            601534,
            601539,
            601543,
            601549,
            601553,
            601559,
            601576,
            601578,
            601584,
            601591,
            601596,
            601600,
            601605,
            601609,
            601614,
            601618,
            601623,
            601629,
            601633,
            601638,
            601645,
            601648,
            601654,
            601659,
            601663,
            601669,
            601675,
            601680,
            601683,
            601689,
            601694,
            601698,
            601704,
            601709,
            601714,
            601720,
            601724,
            597082,
            493173,
            564249,
            608169,
            534408,
            711832,
            625033,
            512979,
            512983,
            542992,
            697523,
            697526,
            697531,
            697536,
            697538,
            697544,
            697548,
            752190,
            698724,
            698727,
            698731,
            756840,
            756847,
            625833,
            625837,
            625842,
            625848,
            625852,
            625978,
            626610,
            512814,
            432836,
            595225,
            670291,
            463013,
            463018,
            463021,
            731618,
            525883,
            644905,
            653119,
            728421,
            728422,
            728428,
            728432,
            728437,
            728441,
            728445,
            728449,
            666945,
            585015,
            585020,
            585028,
            585033,
            585038,
            585042,
            585049,
            585054,
            585060,
            585067,
            585072,
            585079,
            585085,
            585091,
            585098,
            585104,
            585108,
            585115,
            585123,
            585128,
            587855,
            473347,
            473352,
            716712,
            716713,
            716716,
            716718,
            716720,
            716722,
            716724,
            716726,
            716728,
            716730,
            393453,
            393460,
            393467,
            453231,
            463667,
            487984,
            671519,
            671543,
            671549,
            671591,
            710803,
            710805,
            636634,
            713077,
            713082,
            713089,
            713093,
            713099,
            512450,
            512454,
            512456,
            678845,
            744479,
            744484,
            744490,
            744495,
            744500,
            744505,
            744508,
            744515,
            744520,
            744524,
            744530,
            744535,
            744539,
            744544,
            744549,
            651369,
            651374,
            651377,
            536071,
            412338,
            412342,
            412346,
            412350,
            412354,
            412358,
            412362,
            412366,
            412370,
            412374,
            412378,
            412382,
            412386,
            412390,
            412394,
            412398,
            412402,
            412406,
            412410,
            412414,
            412418,
            412422,
            412426,
            412430,
            412434,
            412438,
            412442,
            684743,
            593675,
            716748,
            716750,
            716752,
            716754,
            716756,
            716758,
            716760,
            716762,
            716764,
            716768,
            716770,
            716772,
            716774,
            716776,
            716778,
            716780,
            716782,
            716784,
            716786,
            716788,
            716790,
            716792,
            716794,
            716796,
            716798,
            716802,
            717002,
            717004,
            717006,
            717008,
            700015,
            490844]

    t_ = time.time()
    # for frame in tqdm.tqdm(xrange(vm.total_frame_count())):
    #     for t in p.chm.chunks_in_frame(frame):
    #         if t.is_single():
    #             rch = RegionChunk(t, p.gm, p.rm)

    for r_id in rids:
                r = p.rm[r_id]
                # r = rch.region_in_t(frame)

                img = p.img_manager.get_whole_img(r.frame())

                y, x = r.centroid()
                crop = get_safe_selection(img, y - offset, x - offset, 2 * offset, 2 * offset)
                crop = apply_ellipse_mask(r, crop, MASK_SIGMA, ELLIPSE_DILATION)

                imgs.append(crop)
                ids.append(r.id())
                if len(imgs) == BATCH_SIZE:
                    save_batch(batch_i, imgs, ids)

                    imgs = []
                    ids = []

                    batch_i += 1

                    print "TOTAL TIME: ", time.time() - t_

    if len(imgs):
        save_batch(batch_i, imgs, ids)
